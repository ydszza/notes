# 计算机系统结构

## 1. 内核
### 1.1 什么是内核？
计算机由各种外部硬件组成，如内存，CPU，硬盘等，为了避免每个硬件和应用之间对接通信协议，于是产生了中间人【内核】，作为硬件和应用之间的桥梁  
应用程序只需要关心与内核之间的交互，不需要关心硬件细节

### 1.2 内核的能力
4个基本的能力
- 管理进程、线程、决定哪个进程或线程使用CPU，即进程调度能力
- 管理内存，决定内存的分配和回收，也就是内存管理能力
- 管理硬件设备，为进程与硬件之间提供通信能力，即硬件通信能力
- 提供系统调用，如果应用程序要运行更高的权限运行的服务，需要进行系统调用，即用户程序与操作系统之间的接口

### 1.3 内核如何工作
内核具有很高的权限，可控制CPU、内存、硬盘等硬件，而应用程序权限低。大多数操作系统把内存分为两个区域
- 内核空间：仅内核程序访问
- 用户空间：专门给应用程序使用
用户空间代码只能访问局部的内存空间，而内核空间的代码可以访问所有内存空间。因此当程序使用用户空间时称为处于用户态，当使用内核空间时，称为处于内核态

系统调用过程：当执行系统调用时，产生一个中断，CPU中断进程执行，调到中断程序处理，即执行内核程序，处理完成后，主动触发中断，把CPU执行权交还用户程序
```
            用户程序 ---》 执行系统调用                     系统调用返回
用户态：                            \                    /
-----------------------------------中断---------------中断-------------------------
内核态：                               \              /
                                         执行系统调用
```

## 2. Linux内核设计
### 2.1 Linux内核设计理念
- MutiTask，多任务：即多任务操作系统，多个任务可以同时执行，可以是并发或者并行
    - 单核处理器，让每个任务执行一段时间就切换到另一个任务，即并发
    - 多核处理器，多个任务可以同时被不同的核心同时执行，即并行
- SMP，对称多处理：代表每个CPU的地位相等，资源的使用权限相同，共享系统内存和硬件资源
- ELF：可执行文件链接格式，即可执行文件的存储格式
    - Program header table
    - .test
    - .rodata
    - ...
    - .data
    - Section header table
- Monolithic Kernel,宏内核：Linux是一个完整的可执行程序，且拥有最高权限   
特征就是系统内核的所有模块，如进程调度。内存管理、文件系统、设备驱动等都运行在内核态  
Linux实现了动态加载内核模块的功能，如大部分设备驱动以模块的形式存在，与内核某块解耦，让驱动开发和加载更加方便  
与宏内核相反的是【微内核】，微内核架构只保留了最基本的能力，如进程调度，虚拟内存，中断等，而把如驱动程序，文件系统等放到用户空间，这样服务与服务之间隔离，单个服务故障不会导致系统挂掉，提高稳定性。但是缺点在于驱动程序频繁调用系统调用，性能损耗。  
还有一种是【混合类型内核】，架构类似微内核，有一个最小版本的内核，然后其他模块在此基础搭建，类似于宏内核的方式包裹着一个微内核

## 3. window设计
现在的window 7/10都使用window NT，NT即new technology  
window也支持MutiTask和SMP，但是window内核是混合型内核  
window可执行文件格式叫PE，称为可移植执行文件，扩展名.exe/.dll/.sys  
PE结构：
- DOS Header
- PE Header
- Optional Header
- Section Table
- .text
- .data
- ...
